<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Qiana">





<title>手写Promise | Qiana前端小栈</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.1.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="/">Qiana&#39;s Blog</a>
            </div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">文档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                    <label for="switch_default" class="toggleBtn"></label>
                </div>
            </div>
        </nav>

        
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="/">Qiana&#39;s Blog</a>
                        <a id="mobile-toggle-theme">·&nbsp;Light</a>
                    </div>
                    <div class="menu-toggle" onclick="mobileBtn()">&#9776;</div>
                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/archives">文档</a>
                    
                        <a class="menu-item" href="/category">分类</a>
                    
                        <a class="menu-item" href="/tag">标签</a>
                    
                        <a class="menu-item" href="/about">关于</a>
                    
                </div>
            </div>
        </nav>

    </header>
    <script>
        var mobileBtn = function f() {
            var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
            var mobileMenu = document.getElementById("mobile-menu");
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }
    </script>

        <div class="main">
            <div
    class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">手写Promise</h1>
            
                <div class="post-meta">
                    
                        作者:
                        <a itemprop="author" rel="author" href="/">Qiana</a>&nbsp;&nbsp;
                    

                    
                        <span class="post-time">
                            日期:
                            <a href="#">2020-11-09</a>&nbsp;&nbsp;
                        </span>
                    
                    
                        <span class="post-category">
                            分类:
                            
                                <a href="/categories/JS/">JS</a>&nbsp;&nbsp;
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>理解Promise原理，手写一个MyPromise。</p>
<h1 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h1><h2 id="根据Promise，推断MyPromise"><a href="#根据Promise，推断MyPromise" class="headerlink" title="根据Promise，推断MyPromise"></a>根据Promise，推断MyPromise</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(xxx)&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;resolve&#x27;</span>)</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    reject(<span class="string">&#x27;reject&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">//resolve后继续处理</span></span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">//上一个Promise  reject或出错后处理</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">//reject或出错后处理</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>根据上述代码，我们可以推断</p>
<ol>
<li>Promise是一个类，使用类时需要传递一个执行器，并且执行器立即执行</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromis.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(exector)&#123;</span><br><span class="line">    exector(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>Promise有三种状态：等待（pending）、成功（fulfilled）、失败（rejected）</p>
<p>状态变化: pending –&gt; fulfilled.    </p>
<p>​                 pending –&gt; rejected</p>
<p>默认状态为pending</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED =<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED =<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING =<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MyPromis.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(exector)&#123;</span><br><span class="line">    exector(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  status = PENDING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>resolve,reject是用来更改状态的</p>
<p>resolve   –&gt; fulfilled</p>
<p>reject —&gt; rejected</p>
<p>状态一旦变化，便不可更改</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED =<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED =<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING =<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MyPromis.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(exector)&#123;</span><br><span class="line">    exector(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  status = PENDING;</span><br><span class="line">	resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line">  &#125;</span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>then方法内部判断状态，若状态为成功，调用成功对应的回调函数，若状态为失败，调用失败对应的回调函数。</p>
<p>then方法应该是被定义在原型对象中的。</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED =<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED =<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING =<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MyPromis.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(exector)&#123;</span><br><span class="line">    exector(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  status = PENDING;</span><br><span class="line"></span><br><span class="line">	resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//判断状态，执行对应回调</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status === FULFILLED)&#123;</span><br><span class="line">        successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status === REJECTED)&#123;</span><br><span class="line">        failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//pending 状态处理</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>then成功回调有一个参数，表示成功之后值。失败回调有一个参数，表示失败之后的原因。</p>
<p>在resolve和reject中存储值和原因，便于在then方法中使用，所以要在实例中定义变量。</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初步Promise</span></span><br><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED=<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED=<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING=<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//立即执行执行器</span></span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//默认状态为pending</span></span><br><span class="line">  status = PENDING;</span><br><span class="line">  <span class="comment">//成功后的值</span></span><br><span class="line">  value=<span class="literal">undefined</span></span><br><span class="line">  <span class="comment">//失败之后的原因</span></span><br><span class="line">  reason= <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line">  &#125;</span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为失败</span></span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.reason = reason</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//判断状态，执行对应回调</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status === FULFILLED)&#123;</span><br><span class="line">        successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status === REJECTED)&#123;</span><br><span class="line">        failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//pending 状态处理</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	test.js</span></span><br><span class="line"><span class="keyword">const</span> myPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常打印‘success’</span></span><br></pre></td></tr></table></figure>

<h2 id="实现MyPromise异步"><a href="#实现MyPromise异步" class="headerlink" title="实现MyPromise异步"></a>实现MyPromise异步</h2><p>Promise中，then方法是在执行器执行完毕之后执行的。但前面我们的基本原理代码，在执行器中有异步函数时，then方法中状态处于pending状态，需要进行特殊处理。</p>
<p>then方法中需要将成功回调和失败回调存储起来，便于状态发生变化时调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED=<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED=<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING=<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//立即执行执行器</span></span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//默认状态为pending</span></span><br><span class="line">  status = PENDING;</span><br><span class="line">  <span class="comment">//成功后的值</span></span><br><span class="line">  value=<span class="literal">undefined</span></span><br><span class="line">  <span class="comment">//失败之后的原因</span></span><br><span class="line">  reason= <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//成功回调</span></span><br><span class="line">  successCallback = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//失败回调</span></span><br><span class="line">  failCallback = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异步情况，如果成功回调存在，调用成功回调</span></span><br><span class="line">    <span class="built_in">this</span>.successCallback &amp;&amp; <span class="built_in">this</span>.successCallback(value)</span><br><span class="line">  &#125;</span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为失败</span></span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.reason = reason</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异步情况，如果成功回调存在，调用成功回调</span></span><br><span class="line">    <span class="built_in">this</span>.failCallback &amp;&amp; <span class="built_in">this</span>.failCallback(reason)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//判断状态，执行对应回调</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status === FULFILLED)&#123;</span><br><span class="line">        successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status === REJECTED)&#123;</span><br><span class="line">        failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//pending状态，将回调函数存储起来，方便在resolve或reject执行后调用</span></span><br><span class="line">      <span class="built_in">this</span>.successCallback = successCallback</span><br><span class="line">      <span class="built_in">this</span>.failCallback = failCallback</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> myPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//2s后输出‘success’</span></span><br></pre></td></tr></table></figure>

<h2 id="then方法多次调用"><a href="#then方法多次调用" class="headerlink" title="then方法多次调用"></a>then方法多次调用</h2><p>当then方法被多次调用的时候，每个then方法都要分别执行。</p>
<p><strong>同步时</strong>直接依次盗用then方法中对应的回调函数</p>
<p><strong>异步时</strong>，依次存储then方法中的回调函数，然后在状态发生变化时调用。</p>
<p>成功回调和失败回调的函数存储在数组中，then方法中，状态为status时，push回调函数到数组中，在resolve和reject执行时，再执行回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span>  FULFILLED=<span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  REJECTED=<span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span>  PENDING=<span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//立即执行执行器</span></span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//默认状态为pending</span></span><br><span class="line">  status = PENDING;</span><br><span class="line">  <span class="comment">//成功后的值</span></span><br><span class="line">  value=<span class="literal">undefined</span></span><br><span class="line">  <span class="comment">//失败之后的原因</span></span><br><span class="line">  reason= <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//成功回调函数，存储在数组中，方便依次调用</span></span><br><span class="line">  successCallback = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">//失败回调函数，存储在数组中，方便依次调用</span></span><br><span class="line">  failCallback = []</span><br><span class="line"></span><br><span class="line">  resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为成功</span></span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异步情况，如果成功回调存在，调用成功回调</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.successCallback.length)&#123;</span><br><span class="line">      <span class="built_in">this</span>.successCallback.shift()(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//如果状态不为pending，阻止向下执行</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态为失败</span></span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存成功之后的值，为了在then方法中使用</span></span><br><span class="line">    <span class="built_in">this</span>.reason = reason</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异步情况，如果成功回调存在，调用成功回调</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.successCallback.length)&#123;</span><br><span class="line">      <span class="built_in">this</span>.successCallback.shift()(reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//判断状态，执行对应回调</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status === FULFILLED)&#123;</span><br><span class="line">        successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status === REJECTED)&#123;</span><br><span class="line">        failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//pending状态，将回调函数存储起来，方便在resolve或reject执行后调用</span></span><br><span class="line">      <span class="built_in">this</span>.successCallback.push(successCallback)</span><br><span class="line">      <span class="built_in">this</span>.failCallback.push(failCallback)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> myPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="then方法链式调用"><a href="#then方法链式调用" class="headerlink" title="then方法链式调用"></a>then方法链式调用</h2><p>then方法链式调用，下一个then会接收上一个then方法的返回值。</p>
<p>而then方法是promise类中的方法，所以，then方法的返回值是Promise。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  then(succcessCallBack,failCallback)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>then方法中，下一个then方法可以拿到上一个then方法中回调函数执行的值，故而，需要在上一个then方法中执行resolve或reject方法，并将回调函数的结果传递给下一个then方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//实际下一个then方法执行的是这里的MyPromise的then方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//前一个promise的状态判断，</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//若状态为fulfilled，执行成功回调，并将返回结果传给后一个then方法的Promise，执行resolve</span></span><br><span class="line">        <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">        resolve(x)</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//若状态为rejected，执行失败回调，并将返回结果传给后一个then方法的Promise，执行rejected</span></span><br><span class="line">        <span class="keyword">let</span> reason = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">        reject(reason)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(successCallback)</span><br><span class="line">        <span class="built_in">this</span>.failCallback.push(failCallback)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>若回调函数的返回值为Promise对象，则需要拿到promise对象的的返回值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  resove = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.successCallback.length)&#123;</span><br><span class="line">      <span class="comment">//调用then方法中存储的，用于处理回调函数的函数</span></span><br><span class="line">      <span class="built_in">this</span>.successCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">    <span class="built_in">this</span>.reason = reason</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.failCallback.length)&#123;</span><br><span class="line">      <span class="comment">//调用then方法中存储的，用于处理回调函数的函数</span></span><br><span class="line">      <span class="built_in">this</span>.failCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//实际下一个then方法执行的是这里的MyPromise的then方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//前一个promise的状态判断，</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//若状态为fulfilled，执行成功回调，并将返回结果传给后一个then方法的Promise，执行resolve</span></span><br><span class="line">        <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">        <span class="comment">//若x为普通值，调用reslove(x),返回值</span></span><br><span class="line">        <span class="comment">//若x为Promise对象，需要执行Promise对象内的函数，需要将Promise对象的结果传递给后面的then方法。</span></span><br><span class="line">        <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">          x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          resolve(x)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//若状态为rejected，执行失败回调，并将返回结果传给后一个then方法的Promise，执行rejected</span></span><br><span class="line">        <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">        <span class="comment">//若x为普通值，调用reject(x),返回值</span></span><br><span class="line">        <span class="comment">//若x为Promise对象，需要执行Promise对象内的函数，需要将Promise对象的结果传递给后面的then方法。</span></span><br><span class="line">        <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">          x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          reject(x)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//pengding状态，需要存储一个函数，函数内处理成功或失败回调，便于在resolve或reject方法中使用</span></span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">          <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">            x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resolve(x)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">this</span>.failCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">          <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">            x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            reject(x)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>进一步优化，提取resolvePromise</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  resove = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED</span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.successCallback.length)&#123;</span><br><span class="line">      <span class="comment">//调用then方法中存储的，用于处理回调函数的函数</span></span><br><span class="line">      <span class="built_in">this</span>.successCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">    <span class="built_in">this</span>.reason = reason</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.failCallback.length)&#123;</span><br><span class="line">      <span class="comment">//调用then方法中存储的，用于处理回调函数的函数</span></span><br><span class="line">      <span class="built_in">this</span>.failCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//实际下一个then方法执行的是这里的MyPromise的then方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//前一个promise的状态判断，</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//若状态为fulfilled，执行成功回调，并将返回结果传给后一个then方法的Promise，执行resolve</span></span><br><span class="line">        <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">        resolvePromise(x,resolve,reject)</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//若状态为rejected，执行失败回调，并将返回结果传给后一个then方法的Promise，执行rejected</span></span><br><span class="line">        <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">        resolvePromise(x,resolve,reject)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//pengding状态，需要存储一个函数，函数内处理成功或失败回调，便于在resolve或reject方法中使用</span></span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">          resolvePromise(x,resolve,reject)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">this</span>.failCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">          resolvePromise(x,resolve,reject)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">x,resolve,reject</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//若x为普通值，调用reslove(x),返回值</span></span><br><span class="line">  <span class="comment">//若x为Promise对象，则需要执行Promise对象内的函数，则需要将Promise对象的结果传递给后面的then方法。</span></span><br><span class="line">  <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">    x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    resolve(x)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">  reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">other</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        resolve(<span class="string">&#x27;other&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    <span class="keyword">return</span> other();</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="then方法参数为可选参数"><a href="#then方法参数为可选参数" class="headerlink" title="then方法参数为可选参数"></a>then方法参数为可选参数</h2><p>在实际使用Promise的时候，会有这种情况</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//promise</span></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  resolve(<span class="string">&#x27;成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then().then().then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这个时候，前两then方法中没有回调函数的参数，但是，promise的fulfilled状态是一值保持到有回调函数参数的then方法中执行回调的，所以我们需要将promise的状态一只传递给后面的then方法</p>
<p>相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//promise</span></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  resolve(<span class="string">&#x27;成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">res</span>=&gt;</span>res)</span><br><span class="line">  			.then(<span class="function"><span class="params">res</span>=&gt;</span>res)</span><br><span class="line">  			.then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(res)</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<p>因此，我们只需要在then方法中补充一个函数就可以了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    successCallback = successCallback ? successCallback : <span class="function"><span class="params">value</span> =&gt;</span> value   </span><br><span class="line">    failCallback = failCallback ? failCallback : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;<span class="keyword">throw</span> reason&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理自己返回自己的异常"><a href="#处理自己返回自己的异常" class="headerlink" title="处理自己返回自己的异常"></a>处理自己返回自己的异常</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异常情况：Promise的then的返回值为 返回Promise本身</span></span><br><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p1 = promise.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">    <span class="keyword">return</span> p1;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p1.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//success</span></span><br><span class="line"><span class="comment">//TypeError: Chaining cycle detected for promise #&lt;Promise&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//实际下一个then方法执行的是这里的MyPromise的then方法</span></span><br><span class="line">    <span class="keyword">let</span> promise2 =  <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//前一个promise的状态判断，</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//若状态为fulfilled，执行成功回调，并将返回结果传给后一个then方法的Promise，执行resolve</span></span><br><span class="line">          <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">          resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//若状态为rejected，执行失败回调，并将返回结果传给后一个then方法的Promise，执行rejected</span></span><br><span class="line">          <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">          resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//pengding状态，需要存储一个函数，函数内处理成功或失败回调，便于在resolve或reject方法中使用</span></span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">          	resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">this</span>.failCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">          	resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2,x,resolve,reject</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(promise2===x)&#123;</span><br><span class="line">    <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">    <span class="comment">//x为Promise对象</span></span><br><span class="line">    x.then(<span class="function"><span class="params">value</span>=&gt;</span>resolve(value),<span class="function"><span class="params">reason</span>=&gt;</span>reject(reason))</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//普通值</span></span><br><span class="line">    resolve(x)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        reject(<span class="string">&#x27;reason&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p1 = promise.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">    <span class="keyword">return</span> p1;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p1.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><ol>
<li>Promise执行器中异常捕获抛出</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//立即执行执行器,并捕获抛出异常</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">      <span class="comment">//若有异常，直接执行reject，抛出异常原因</span></span><br><span class="line">      <span class="built_in">this</span>.reject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;execuor error&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason.message)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//输出&#x27;execuor error&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>then方法中的回调函数在执行过程中发生错误，在下一个then方法中要将异常捕获抛出</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//实际下一个then方法执行的是这里的MyPromise的then方法</span></span><br><span class="line">    <span class="keyword">let</span> promise2 =  <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//前一个promise的状态判断，</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//捕获抛出异常</span></span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//若状态为fulfilled，执行成功回调，并将返回结果传给后一个then方法的Promise，执行resolve</span></span><br><span class="line">            <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">            resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            reject(e)</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//捕获抛出异常</span></span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//若状态为rejected，执行失败回调，并将返回结果传给后一个then方法的Promise，执行rejected</span></span><br><span class="line">            <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">            resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            reject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//pengding状态，需要存储一个函数，函数内处理成功或失败回调，便于在resolve或reject方法中使用</span></span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">//捕获抛出异常</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">              <span class="keyword">let</span> x = successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">              resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">              reject(e)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">this</span>.failCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">//设置异步，确保promise2在使用时已经定义存在</span></span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">//捕获抛出异常</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">              <span class="keyword">let</span> x = failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">              resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">              reject(e)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;then error&#x27;</span>)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason.message)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason.message)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//输出&#x27;成功&#x27;</span></span><br><span class="line"><span class="comment">//输出‘then error’</span></span><br></pre></td></tr></table></figure>

<h1 id="核心功能代码汇总"><a href="#核心功能代码汇总" class="headerlink" title="核心功能代码汇总"></a>核心功能代码汇总</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//状态</span></span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//立即执行器</span></span><br><span class="line">  <span class="keyword">constructor</span>(executor)&#123;</span><br><span class="line">    <span class="comment">//异常捕获抛出</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      executor(<span class="built_in">this</span>.resolve,<span class="built_in">this</span>.reject)</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">      <span class="built_in">this</span>.reject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//默认状态</span></span><br><span class="line">  status = PENDING;</span><br><span class="line">  <span class="comment">//记录value及reason便于在then方法中使用</span></span><br><span class="line">	value = <span class="literal">undefined</span>;</span><br><span class="line">	reason = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">//成功、失败回调函数记录，数组是为了then方法的链式连续调用</span></span><br><span class="line">	successCallback = [];</span><br><span class="line">	failCallback = [];</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * resolve函数</span></span><br><span class="line"><span class="comment"> * 1. 状态只能有pending转变为fulfilled</span></span><br><span class="line"><span class="comment"> * 2.修改状态为fulfilled</span></span><br><span class="line"><span class="comment"> * 3.记录value值</span></span><br><span class="line"><span class="comment"> * 4.异步代码调用resolve时，执行存储起来的then方法中的成功回调函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	resolve = <span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = FULFILLED;</span><br><span class="line">    <span class="built_in">this</span>.value = value;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.successCallback.length)&#123;</span><br><span class="line">      <span class="built_in">this</span>.successCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * reject</span></span><br><span class="line"><span class="comment"> * 1. 状态只能有pending转变为rejected</span></span><br><span class="line"><span class="comment"> * 2.修改状态为rejected</span></span><br><span class="line"><span class="comment"> * 3.记录reason值</span></span><br><span class="line"><span class="comment"> * 4.异步代码调用reject时，执行存储起来的then方法中的失败回调函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.status !== PENDING)&#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.status = REJECTED;</span><br><span class="line">    <span class="built_in">this</span>.reason = reason;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.failCallback.length)&#123;</span><br><span class="line">      <span class="built_in">this</span>.failCallback.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * then方法</span></span><br><span class="line"><span class="comment"> * 1.为了then链式调用，返回Promise对象</span></span><br><span class="line"><span class="comment"> * 2.根据status的状态值，处理成功回调函数及失败回调函数</span></span><br><span class="line"><span class="comment"> *   若状态值为pending，则存储处理成功回调的函数及处理失败回调的函数</span></span><br><span class="line"><span class="comment"> * 3.若回调函数返回的值为普通值，则执行resolve，将返回值传递够后续then方法</span></span><br><span class="line"><span class="comment"> *  若回调函数的返回值为Promise，则进一步执行改Promise的then方法，并执行then方法中的成功或失败回调函数，得到普通值，返回给续后then方法使用</span></span><br><span class="line"><span class="comment"> * 4.若回调函数执行过程中出现异常，则抛出异常</span></span><br><span class="line"><span class="comment"> * 5.为了避免then方法返回其Promise本身，即then方法回调函数的返回值即then方法的返回值，需采用异步方法，判断回调函数返回值是否与then方法返回的Promise相等。</span></span><br><span class="line"><span class="comment"> * 6.then方法没有传递成功回调或失败回调的时候，将Promise的状态原样传递</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>successCallback 成功回调</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>failCallback 失败回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  </span><br><span class="line">  then(successCallback,failCallback)&#123;</span><br><span class="line">    <span class="comment">//若存在回调函数，则使用原有函数，否则补一个函数</span></span><br><span class="line">    successCallback  =  successCallback ? successCallback : <span class="function"><span class="params">value</span>=&gt;</span>value</span><br><span class="line">    failCallback  =  failCallback ? failCallback : <span class="function"><span class="params">reason</span>=&gt;</span>&#123;<span class="keyword">throw</span> reason&#125;</span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.status == FULFILLED)&#123;</span><br><span class="line">        <span class="comment">//成功</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> x= successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">            resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            reject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">this</span>.status == REJECTED)&#123;</span><br><span class="line">        <span class="comment">//失败</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> x= failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">            resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            reject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//successCallback push 函数，函数内处理成功回调</span></span><br><span class="line">        <span class="built_in">this</span>.successCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">							<span class="keyword">let</span> x= successCallback(<span class="built_in">this</span>.value)</span><br><span class="line">            	resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">              reject(e)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="comment">//failCallback push 函数，函数内处理失败回调</span></span><br><span class="line">      <span class="built_in">this</span>.failCallback.push(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">							<span class="keyword">let</span> x= failCallback(<span class="built_in">this</span>.reason)</span><br><span class="line">            	resolvePromise(promise2,x,resolve,reject)</span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">              reject(e)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>promise2 then方法返回的promise对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>x 回调函数返回值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>resolve promise2的resolve方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>reject promise2的reject方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2,x,resolve,reject</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(promise2 === x)&#123;</span><br><span class="line">   <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(x <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">    x.then(<span class="function">(<span class="params">value</span>)=&gt;</span>resolve(value),<span class="function">(<span class="params">reason</span>)=&gt;</span>reject(reason))</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    resolve(x)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// resolve(&#x27;success&#x27;)</span></span><br><span class="line">        reject(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then().then().then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        reject(<span class="string">&#x27;resolve&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        reject(<span class="string">&#x27;reject&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h1><h2 id="all方法"><a href="#all方法" class="headerlink" title="all方法"></a>all方法</h2><p>all方法是用来解决异步并发问题的，它允许我们按照异步代码调用的顺序得到异步代码执行的结果。</p>
<p>接收一个数组作为参数，数组中可以是普通值和Promise对象，数组中值得顺序即为得到的结果的顺序。</p>
<p>返回值是一个Promise对象，可以链式调用then方法。</p>
<p>若all的参数中，所有Promise对象的结果都是成功的，则all结果也是成功的。</p>
<p>若all的参数中，有Promise对象的结果是失败的，则all结果也是失败的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例子</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      resolve(<span class="string">&#x27;p1&#x27;</span>)</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;p2&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.all([<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,p1(),p2(),<span class="string">&#x27;c&#x27;</span>])</span><br><span class="line">	.then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;p1&#x27;,&#x27;p2&#x27;,&#x27;c&#x27;]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  <span class="keyword">static</span> all(array)&#123;</span><br><span class="line">    <span class="comment">//结果数组</span></span><br><span class="line">    <span class="keyword">let</span> result = []</span><br><span class="line">    <span class="comment">//用于标记所有参数执行完成</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//存储result</span></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">key,value</span>)</span>&#123;</span><br><span class="line">        result[key] = value</span><br><span class="line">        <span class="comment">//每处理完一个参数，index++</span></span><br><span class="line">        index++;</span><br><span class="line">        <span class="comment">//所有参数处理完成后，index的数值与数组长度一致</span></span><br><span class="line">        <span class="keyword">if</span>(index === array.length)&#123;</span><br><span class="line">          resolve(result)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;array.length;i++)&#123;</span><br><span class="line">        <span class="keyword">let</span> current = array[i]</span><br><span class="line">        <span class="keyword">if</span>(current <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">          <span class="comment">//promise 对象</span></span><br><span class="line">          current.then(<span class="function"><span class="params">value</span>=&gt;</span>&#123;</span><br><span class="line">            addData(i,value)</span><br><span class="line">          &#125;,<span class="function"><span class="params">reason</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">//有一个失败即失败</span></span><br><span class="line">            reject(reason)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">//普通值</span></span><br><span class="line">          addData(i,current)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">const</span> MyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./myPromise&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;p1&#x27;</span>)</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;p2&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">MyPromise.all([<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,p1(),p2(),<span class="string">&#x27;c&#x27;</span>])</span><br><span class="line">    .then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">//[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;p1&#x27;,&#x27;p2&#x27;,&#x27;c&#x27;]</span></span><br></pre></td></tr></table></figure>

<h2 id="resolve方法"><a href="#resolve方法" class="headerlink" title="resolve方法"></a>resolve方法</h2><p>将给定的值转换为Promise对象。所以，resolve方法的返回值是一个Promise对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例子</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">10</span>).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">Promise</span>.resolve(p1()).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  <span class="keyword">static</span> resolve(value)&#123;</span><br><span class="line">    <span class="keyword">if</span>(value <span class="keyword">instanceof</span> MyPromise)&#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">        resolve(value)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="finally方法"><a href="#finally方法" class="headerlink" title="finally方法"></a>finally方法</h2><p>无论当前Promise对象最终的状态是成功的还是失败的，finally方法中的函数都会被执行一次。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  <span class="keyword">finally</span>(callback)&#123;</span><br><span class="line">    <span class="comment">//then 方法中的成功或失败都要执行回调函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">//处理callback中有异步的情况，将callback的返回值处理为Promise</span></span><br><span class="line">      <span class="comment">//等待Promise执行完成之后，才处理then方法中的内容</span></span><br><span class="line">      <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function">()=&gt;</span>value)</span><br><span class="line">    &#125;,<span class="function">(<span class="params">reason</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function">()=&gt;</span>&#123;<span class="keyword">throw</span> reason&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="catch方法"><a href="#catch方法" class="headerlink" title="catch方法"></a>catch方法</h2><p>用来处理Promise对象失败的情况</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyPromise.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  <span class="comment">//...省略前面代码</span></span><br><span class="line">  <span class="keyword">catch</span>(failCallback)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="literal">undefined</span>,failCallback)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...省略后面代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
        </div>

        
        <section class="post-tags">
            <div>
                <span>
                    标签:</span>
                <span class="tag">
                    
                        
                            <a href="/tags/JS/">#
                                JS</a>
                        
                            <a href="/tags/Promise/">#
                                Promise</a>
                        
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">后退
                </a>
                <span>·
                </span>
                <a href="/">首页</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/11/09/algorithm/LeetCode1/">每日算法-LeetCode1-两数之和</a>
            
            
                <a class="next" rel="next" href="/2020/10/23/JS/asynchronous-programming/">JS异步编程</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Qiana | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
